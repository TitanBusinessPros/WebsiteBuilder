<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landing Page Builder - Fixed</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@400;700&family=Roboto+Condensed:wght@400;700&family=Open+Sans:wght@400;600;700&family=Lora:wght@400;700&family=Roboto+Mono:wght@400;700&family=Nunito:wght@400;700&family=Merriweather:wght@400;700&family=Fira+Sans:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Oswald:wght@400;700&family=Raleway:wght@400;700&family=PT+Sans:wght@400;700&family=Noto+Sans:wght@400;700&display=swap">
    <style>
        /* === Builder Styles === */
        .lpb { 
            --gap: 12px; 
            --radius: 14px; 
            --shadow: 0 6px 30px rgba(0,0,0,.08); 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
            background: #f5f7fa;
            padding: 20px;
            min-height: 100vh;
        }
        .lpb * { box-sizing: border-box; }
        .lpb-card { 
            max-width: 980px; 
            margin: 24px auto; 
            padding: 30px; 
            background:#fff; 
            border:1px solid #e9ecef; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
        }
        .lpb-h1 { 
            font-size: 1.8rem; 
            margin: 0 0 15px; 
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lpb-h1 small {
            font-size: 0.6em; 
            color: #4c6ef5; 
            font-weight: normal;
        }
        .lpb-h2 { 
            font-size: 1.4rem; 
            margin: 20px 0 15px; 
            color: #2d3748;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        .lpb-h3 { font-size: 1rem; margin: 0; }
        .lpb-grid { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            gap: var(--gap); 
        }
        .lpb-field { 
            grid-column: span 12; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .lpb-field > label { 
            font-weight: 600; 
            color: #2d3748;
            font-size: 0.95rem;
        }
        .lpb-field input[type="text"], 
        .lpb-field textarea, 
        .lpb-field select, 
        .lpb-field input[type="color"] {
            padding: 12px 14px; 
            border: 1px solid #cfd4da; 
            border-radius: 10px; 
            font: inherit; 
            background:#fff;
            transition: all 0.2s;
        }
        .lpb-field input[type="text"]:focus, 
        .lpb-field textarea:focus, 
        .lpb-field select:focus {
            border-color: #4c6ef5;
            box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.1);
            outline: none;
        }
        .lpb-field input[type="color"] { 
            height: 42px; 
            padding: 4px; 
            cursor: pointer;
        }
        .lpb-help { 
            color:#6c757d; 
            font-size: 0.85rem;
        }
        .lpb-row { 
            display:flex; 
            align-items:center; 
            gap:12px; 
        }
        .lpb-between { justify-content: space-between; }
        .lpb-check { 
            display:flex; 
            align-items:center; 
            gap:8px; 
            user-select:none; 
            font-weight: 500;
        }
        .lpb-thumb img { 
            display:block; 
            max-width: 260px; 
            max-height: 140px; 
            border-radius:10px; 
            border:1px solid #e9ecef; 
            margin-top: 8px;
        }
        .lpb-hr { 
            border:0; 
            height:1px; 
            background:linear-gradient(90deg,#eee,#ddd,#eee); 
            margin:24px 0; 
        }
        .lpb-actions { 
            display:flex; 
            justify-content:flex-end; 
            gap:10px; 
            margin-top: 24px; 
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .lpb-btn { 
            border:1px solid #cfd4da; 
            background:#f8f9fa; 
            padding:12px 20px; 
            border-radius: 999px; 
            cursor:pointer; 
            font-weight:600; 
            transition: all 0.2s;
        }
        .lpb-btn:hover { 
            background:#eff2f5; 
            transform: translateY(-2px);
        }
        .lpb-btn-primary { 
            border-color:#4c6ef5; 
            background:#4c6ef5; 
            color:#fff; 
            box-shadow: 0 4px 10px rgba(76, 110, 245, 0.3);
        }
        .lpb-btn-primary:hover { 
            background:#3b5bdb; 
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 110, 245, 0.4);
        }
        .lpb-btn-ghost { background:transparent; }
        .lpb-sec { 
            padding:20px; 
            border:1px dashed #cfd4da; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            background:#fbfcfe; 
            transition: all 0.2s;
        }
        .lpb-sec:hover {
            border-color: #4c6ef5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .lpb-sec .lpb-row { flex-wrap: wrap; }
        .lpb-sec .lpb-col { flex:1 1 260px; min-width: 240px; }
        .lpb-sec .lpb-thumb img { max-width:180px; max-height:120px; }
        .lpb-sec-head { 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
            margin-bottom:15px; 
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .lpb-sec-head strong {
            font-size: 1.1rem;
            color: #2d3748;
        }
        .lpb-del { 
            background:#ffe3e3; 
            border-color:#ffa8a8; 
            color: #fa5252;
        }
        .lpb-del:hover { 
            background:#ffc9c9; 
            color: #e03131;
        }
        .lpb-move { 
            background:#e7f5ff; 
            border-color:#74c0fc; 
            color: #339af0;
        }
        .lpb-move:hover { 
            background:#d0ebff; 
            color: #1c7ed6;
        }

        /* Modal */
        .lpb-modal { 
            position: fixed; 
            inset: 0; 
            display:none; 
            z-index: 9999; 
        }
        .lpb-modal.show { display:block; }
        .lpb-backdrop { 
            position:absolute; 
            inset:0; 
            background:rgba(0,0,0,.5);
            backdrop-filter: blur(4px);
        }
        .lpb-modal-card { 
            position:relative; 
            z-index:1; 
            max-width: 980px; 
            margin: 5vh auto; 
            background:#fff; 
            border-radius: 16px; 
            box-shadow: var(--shadow); 
            padding: 24px; 
            border:1px solid #e9ecef; 
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .lpb-modal-head { 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
            gap:12px; 
            margin-bottom:15px; 
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .lpb-output { 
            width:100%; 
            height: 60vh; 
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
            font-size: 13px; 
            border:1px solid #e1e4e8; 
            border-radius: 10px; 
            padding: 15px; 
            background:#fafbfc; 
            resize: none;
            flex-grow: 1;
        }
        .lpb-hint { 
            margin-top: 12px; 
            color:#6c757d; 
            font-size:.9rem; 
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .lpb-copyright { 
            text-align: center; 
            margin-top: 30px; 
            color: #6c757d; 
            font-size: 0.9rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 12px; 
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .lpb-footer-btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 8px 16px; 
            background: #4c6ef5; 
            color: white; 
            text-decoration: none; 
            border-radius: 999px; 
            font-size: 0.85rem; 
            font-weight: 500; 
            transition: background 0.2s; 
        }
        .lpb-footer-btn:hover { 
            background: #3b5bdb; 
            transform: translateY(-2px);
        }
        .lpb-footer-btn.paste { 
            background: #fa5252; 
        }
        .lpb-footer-btn.paste:hover { 
            background: #e03131; 
        }
        
        /* Performance optimizations */
        .lpb-sec-content { transition: opacity 0.2s; }
        .lpb-loading { opacity: 0.7; pointer-events: none; }
        
        @media (min-width: 700px) {
            .lpb-field:nth-child(1), 
            .lpb-field:nth-child(2), 
            .lpb-field:nth-child(3) { 
                grid-column: span 6; 
            }
            .lpb-field:nth-child(4) { grid-column: span 12; }
        }

        /* Preview Section */
        .preview-container {
            margin-top: 30px;
            border: 2px dashed #4c6ef5;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .preview-title {
            font-size: 1.2rem;
            color: #2d3748;
            margin: 0;
        }
        .preview-content {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: white;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- === Landing Page Code Builder === -->
    <section id="lpb-root" class="lpb">
        <div class="lpb-card">
            <h1 class="lpb-h1">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 18L12 6" stroke="#4c6ef5" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 12H18" stroke="#4c6ef5" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Landing Page Builder 
                <small>(Six Image Max - Allow 30 Seconds For Code To Appear)</small>
            </h1>

            <div class="lpb-grid">
                <div class="lpb-field">
                    <label>Site Title (for browser tab & SEO)</label>
                    <input id="lpb-site-title" type="text" placeholder="My Awesome Product" value="My Awesome Product">
                </div>

                <div class="lpb-field">
                    <label>Base Font</label>
                    <select id="lpb-font">
                        <option value="system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">Clean Sans (system)</option>
                        <option value="Georgia, Times, serif">Serif (Georgia)</option>
                        <option value="Arial, Helvetica, sans-serif">Arial/Helvetica</option>
                        <option value="Tahoma, Verdana, sans-serif">Tahoma/Verdana</option>
                        <option value="'Courier New', Courier, monospace">Monospace</option>
                        <option value="'Poppins', sans-serif" selected>Poppins (Modern)</option>
                        <option value="'Montserrat', sans-serif">Montserrat (Clean)</option>
                        <option value="'Playfair Display', serif">Playfair (Elegant)</option>
                        <option value="'Roboto Condensed', sans-serif">Roboto Condensed</option>
                        <option value="'Open Sans', sans-serif">Open Sans (Friendly)</option>
                        <option value="'Lora', serif">Lora (Elegant)</option>
                        <option value="'Roboto Mono', monospace">Roboto Mono (Code)</option>
                        <option value="'Nunito', sans-serif">Nunito (Rounded)</option>
                        <option value="'Merriweather', serif">Merriweather (Readable)</option>
                        <option value="'Fira Sans', sans-serif">Fira Sans (Tech)</option>
                        <option value="'Source Sans Pro', sans-serif">Source Sans Pro (Clean)</option>
                        <option value="'Oswald', sans-serif">Oswald (Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Elegant)</option>
                        <option value="'PT Sans', sans-serif">PT Sans (Neutral)</option>
                        <option value="'Noto Sans', sans-serif">Noto Sans (Universal)</option>
                    </select>
                </div>

                <div class="lpb-field">
                    <label>Base Font Size</label>
                    <select id="lpb-base-size">
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18" selected>18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="22">22</option>
                        <option value="24">24</option>
                        <option value="26">26</option>
                        <option value="28">28</option>
                        <option value="30">30</option>
                    </select>
                </div>

                <div class="lpb-field lpb-row">
                    <label class="lpb-check">
                        <input id="lpb-bold-headings" type="checkbox" checked> Bold Headings
                    </label>
                    <label class="lpb-check">
                        <input id="lpb-bold-body" type="checkbox"> Bold Body Text
                    </label>
                </div>
            </div>

            <hr class="lpb-hr">

            <h2 class="lpb-h2">Color Scheme</h2>
            <div class="lpb-grid">
                <div class="lpb-field">
                    <label>Primary Color</label>
                    <input id="lpb-primary-color" type="color" value="#4c6ef5">
                </div>
                <div class="lpb-field">
                    <label>Text Color</label>
                    <input id="lpb-text-color" type="color" value="#1f2937">
                </div>
                <div class="lpb-field lpb-row">
                    <label class="lpb-check">
                        <input id="lpb-use-gradient" type="checkbox" checked> Use Gradient Background
                    </label>
                </div>
            </div>

            <hr class="lpb-hr">

            <h2 class="lpb-h2">Hero Section</h2>
            <div class="lpb-grid">
                <div class="lpb-field">
                    <label>Hero Heading</label>
                    <input id="lpb-hero-heading" type="text" placeholder="Build beautiful websites effortlessly" value="Build beautiful websites effortlessly">
                </div>
                <div class="lpb-field">
                    <label>Hero Subheading</label>
                    <textarea id="lpb-hero-sub" rows="2" placeholder="A simple template that becomes real HTML in one click.">A simple template that becomes real HTML in one click.</textarea>
                </div>
                <div class="lpb-field">
                    <label>Call-To-Action Text</label>
                    <input id="lpb-hero-cta" type="text" placeholder="Get Started" value="Get Started">
                </div>
                <div class="lpb-field">
                    <label>CTA Link URL</label>
                    <input id="lpb-hero-link" type="text" placeholder="https://example.com" value="https://example.com">
                </div>
                <div class="lpb-field">
                    <label>Hero Image (optional)</label>
                    <input id="lpb-hero-img" type="file" accept="image/*">
                    <small class="lpb-help">JPG is great; PNG/WebP/GIF also work. We'll embed it directly.</small>
                    <div id="lpb-hero-thumb" class="lpb-thumb"></div>
                </div>
                <div class="lpb-field">
                    <label>Hero Image Alt Text</label>
                    <input id="lpb-hero-alt" type="text" placeholder="Screenshot of the product" value="App Dashboard">
                </div>
                <div class="lpb-field">
                    <label>Hero Image Position</label>
                    <select id="lpb-hero-img-pos">
                        <option value="right" selected>Right of Text</option>
                        <option value="below">Below Text</option>
                        <option value="left">Left of Text</option>
                        <option value="background">As Background</option>
                    </select>
                </div>
            </div>

            <hr class="lpb-hr">

            <div class="lpb-row lpb-between">
                <h2 class="lpb-h2">Content Sections</h2>
                <button id="lpb-add-section" class="lpb-btn lpb-btn-primary">+ Add Section</button>
            </div>
            <div id="lpb-sections"></div>

            <!-- Preview Section -->
            <div class="preview-container">
                <div class="preview-header">
                    <h3 class="preview-title">Live Preview</h3>
                    <button id="lpb-refresh-preview" class="lpb-btn">Refresh Preview</button>
                </div>
                <div class="preview-content" id="preview-content">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">Preview will appear here after generating code</p>
                </div>
            </div>

            <div class="lpb-actions">
                <button id="lpb-generate" class="lpb-btn lpb-btn-primary">Generate HTML Code</button>
            </div>
            
            <div class="lpb-copyright">
                <span>&copy; Copyright 2025 Titan Business Pros LLC</span>
                <a href="https://titanbusinesspros.github.io/MooreOklahoma/" class="lpb-footer-btn" target="_blank">Contact</a>
                <a href="https://titanbusinesspros.github.io/HTMLPlayground1.0/" class="lpb-footer-btn paste" target="_blank">Paste Code</a>
            </div>
        </div>

        <!-- Code Modal -->
        <div id="lpb-modal" class="lpb-modal" aria-hidden="true">
            <div class="lpb-modal-card" role="dialog" aria-modal="true" aria-labelledby="lpb-modal-title">
                <div class="lpb-modal-head">
                    <h3 id="lpb-modal-title" class="lpb-h3">Your Landing Page HTML</h3>
                    <div class="lpb-modal-actions">
                        <button id="lpb-copy" class="lpb-btn lpb-btn-primary">Copy Code</button>
                        <button id="lpb-minify" class="lpb-btn">Minify</button>
                        <button id="lpb-close" class="lpb-btn lpb-btn-ghost" aria-label="Close">×</button>
                    </div>
                </div>
                <textarea id="lpb-output" class="lpb-output" rows="16" readonly></textarea>
                <div class="lpb-hint">
                    <strong>Tip:</strong> Paste this into a new <code>.html</code> file or your existing project.
                    The code includes all images as data URLs, so it will work even when offline.
                </div>
            </div>
            <div class="lpb-backdrop"></div>
        </div>
    </section>

    <script>
        (function(){
            const root = document.getElementById('lpb-root');
            const $ = (sel, par=root) => par.querySelector(sel);
            const $$ = (sel, par=root) => Array.from(par.querySelectorAll(sel));

            // State
            const state = {
                heroImgData: null,
                heroImgPos: 'right',
                heroLink: 'https://example.com',
                sections: [] // { id, title, text, imgData, alt, imgPos, buttonText, buttonLink }
            };

            // Helpers
            const escapeHTML = (str='') => str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            const readFileAsDataURL = file => new Promise((res, rej) => {
                const fr = new FileReader();
                fr.onload = () => res(fr.result);
                fr.onerror = rej;
                fr.readAsDataURL(file);
            });

            // Debounce function to limit how often a function can fire
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Hero image upload
            $('#lpb-hero-img').addEventListener('change', async (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) return;
                if (!/^image\//.test(f.type)) { alert('Please choose an image file.'); e.target.value = ''; return; }
                
                // Show loading state
                const thumbContainer = $('#lpb-hero-thumb');
                thumbContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Loading image...</div>';
                
                try {
                    const dataURL = await readFileAsDataURL(f);
                    state.heroImgData = dataURL;
                    thumbContainer.innerHTML = '<img alt="" src="'+dataURL+'">';
                } catch (error) {
                    alert('Error loading image. Please try another file.');
                    console.error('Image loading error:', error);
                    thumbContainer.innerHTML = '';
                }
            });

            // Hero image position
            $('#lpb-hero-img-pos').addEventListener('change', (e) => {
                state.heroImgPos = e.target.value;
            });

            // Hero link
            $('#lpb-hero-link').addEventListener('input', debounce(e => {
                state.heroLink = e.target.value;
            }, 300));

            // Sections UI
            const sectionsEl = $('#lpb-sections');

            function addSection(prefill){
                const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());
                const sec = Object.assign({ id, title:'Features', text:'Describe your amazing features here...', imgData:null, alt:'Feature illustration', imgPos:'right', buttonText: 'Learn More', buttonLink: 'https://example.com' }, prefill||{});
                state.sections.push(sec);
                renderSections();
            }

            function removeSection(id){
                const i = state.sections.findIndex(s => s.id === id);
                if (i >= 0) { state.sections.splice(i,1); renderSections(); }
            }

            function moveSection(id, dir){
                const i = state.sections.findIndex(s => s.id === id);
                if (i < 0) return;
                const j = i + (dir === 'up' ? -1 : 1);
                if (j < 0 || j >= state.sections.length) return;
                [state.sections[i], state.sections[j]] = [state.sections[j], state.sections[i]];
                renderSections();
            }

            function renderSections(){
                // Only re-render if necessary (when sections are added, removed, or reordered)
                sectionsEl.innerHTML = '';
                state.sections.forEach((sec, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'lpb-sec';
                    wrapper.setAttribute('data-section-id', sec.id);
                    
                    // Only include the image if it exists to prevent data URL bloat
                    const thumbHTML = sec.imgData ? `<img alt="" src="${sec.imgData}">` : '';
                    
                    wrapper.innerHTML = `
                        <div class="lpb-sec-head">
                            <strong>Section ${idx+1}</strong>
                            <div class="lpb-row">
                                <button class="lpb-btn lpb-move" data-act="up">↑</button>
                                <button class="lpb-btn lpb-move" data-act="down">↓</button>
                                <button class="lpb-btn lpb-del" data-act="del">Delete</button>
                            </div>
                        </div>
                        <div class="lpb-sec-content">
                            <div class="lpb-row">
                                <div class="lpb-col">
                                    <label>Section Title</label>
                                    <input type="text" data-key="title" value="${escapeHTML(sec.title)}" placeholder="Features">
                                </div>
                                <div class="lpb-col">
                                    <label>Image (optional)</label>
                                    <input type="file" accept="image/*" data-key="img">
                                    <div class="lpb-thumb">${thumbHTML}</div>
                                </div>
                            </div>
                            <div class="lpb-field" style="margin-top:8px">
                                <label>Image Alt Text</label>
                                <input type="text" data-key="alt" value="${escapeHTML(sec.alt)}" placeholder="Illustration of feature list">
                            </div>
                            <div class="lpb-field" style="margin-top:8px">
                                <label>Image Position</label>
                                <select data-key="imgPos">
                                    <option value="right" ${sec.imgPos === 'right' ? 'selected' : ''}>Right of Text</option>
                                    <option value="left" ${sec.imgPos === 'left' ? 'selected' : ''}>Left of Text</option>
                                    <option value="above" ${sec.imgPos === 'above' ? 'selected' : ''}>Above Text</option>
                                    <option value="below" ${sec.imgPos === 'below' ? 'selected' : ''}>Below Text</option>
                                </select>
                            </div>
                            <div class="lpb-field" style="margin-top:8px">
                                <label>Section Text</label>
                                <textarea rows="3" data-key="text" placeholder="Describe your product...">${escapeHTML(sec.text)}</textarea>
                            </div>
                            <div class="lpb-row">
                                <div class="lpb-field" style="flex: 1;">
                                    <label>Button Text (optional)</label>
                                    <input type="text" data-key="buttonText" value="${escapeHTML(sec.buttonText)}" placeholder="Learn More">
                                </div>
                                <div class="lpb-field" style="flex: 2;">
                                    <label>Button Link URL</label>
                                    <input type="text" data-key="buttonLink" value="${escapeHTML(sec.buttonLink)}" placeholder="https://example.com">
                                </div>
                            </div>
                        </div>
                    `;
                    sectionsEl.appendChild(wrapper);

                    // Wire inputs with debouncing for better performance
                    const titleEl = wrapper.querySelector('input[data-key="title"]');
                    const textEl  = wrapper.querySelector('textarea[data-key="text"]');
                    const altEl   = wrapper.querySelector('input[data-key="alt"]');
                    const imgEl   = wrapper.querySelector('input[data-key="img"]');
                    const imgPosEl = wrapper.querySelector('select[data-key="imgPos"]');
                    const buttonTextEl = wrapper.querySelector('input[data-key="buttonText"]');
                    const buttonLinkEl = wrapper.querySelector('input[data-key="buttonLink"]');
                    const contentEl = wrapper.querySelector('.lpb-sec-content');

                    // Debounced input handlers to prevent performance issues
                    titleEl.addEventListener('input', debounce(e => {
                        sec.title = e.target.value;
                    }, 300));

                    textEl.addEventListener('input', debounce(e => {
                        sec.text = e.target.value;
                    }, 300));

                    altEl.addEventListener('input', debounce(e => {
                        sec.alt = e.target.value;
                    }, 300));

                    imgPosEl.addEventListener('change', e => {
                        sec.imgPos = e.target.value;
                    });

                    buttonTextEl.addEventListener('input', debounce(e => {
                        sec.buttonText = e.target.value;
                    }, 300));

                    buttonLinkEl.addEventListener('input', debounce(e => {
                        sec.buttonLink = e.target.value;
                    }, 300));

                    imgEl.addEventListener('change', async (e) => {
                        const f = e.target.files && e.target.files[0];
                        if (!f) return;
                        if (!/^image\//.test(f.type)) { 
                            alert('Please choose an image file.'); 
                            e.target.value = ''; 
                            return; 
                        }
                        
                        // Show loading state
                        contentEl.classList.add('lpb-loading');
                        const thumbContainer = wrapper.querySelector('.lpb-thumb');
                        thumbContainer.innerHTML = '<div style="padding: 10px; text-align: center; color: #6c757d; font-size: 0.9em;">Loading...</div>';
                        
                        try {
                            sec.imgData = await readFileAsDataURL(f);
                            // Only update the thumbnail, not the entire section
                            thumbContainer.innerHTML = `<img alt="" src="${sec.imgData}">`;
                        } catch (error) {
                            alert('Error loading image. Please try another file.');
                            console.error('Image loading error:', error);
                            thumbContainer.innerHTML = '';
                        } finally {
                            contentEl.classList.remove('lpb-loading');
                        }
                    });

                    wrapper.querySelector('[data-act="del"]').addEventListener('click', () => removeSection(sec.id));
                    wrapper.querySelector('[data-act="up"]').addEventListener('click', () => moveSection(sec.id,'up'));
                    wrapper.querySelector('[data-act="down"]').addEventListener('click', () => moveSection(sec.id,'down'));
                });
            }

            // Initial one section for friendliness
            addSection();

            // Add Section button
            $('#lpb-add-section').addEventListener('click', () => addSection());

            // Update preview function
            function updatePreview() {
                const html = generateHTML();
                const preview = $('#preview-content');
                preview.innerHTML = html;
                
                // Extract and apply styles
                const styleMatch = html.match(/<style>([\s\S]*?)<\/style>/);
                if (styleMatch && styleMatch[1]) {
                    const style = document.createElement('style');
                    style.textContent = styleMatch[1];
                    preview.appendChild(style);
                }
                
                // Extract and set body content
                const bodyMatch = html.match(/<body>([\s\S]*?)<\/body>/);
                if (bodyMatch && bodyMatch[1]) {
                    preview.innerHTML = bodyMatch[1];
                    
                    // Re-add the style
                    if (styleMatch && styleMatch[1]) {
                        const style = document.createElement('style');
                        style.textContent = styleMatch[1];
                        preview.appendChild(style);
                    }
                }
            }

            // Refresh preview button
            $('#lpb-refresh-preview').addEventListener('click', updatePreview);

            // Code generation
            function generateHTML() {
                const siteTitle = $('#lpb-site-title').value.trim() || 'Landing Page';
                const font = $('#lpb-font').value;
                const baseSize = parseInt($('#lpb-base-size').value, 10) || 18;
                const boldHeadings = $('#lpb-bold-headings').checked;
                const boldBody = $('#lpb-bold-body').checked;
                const primaryColor = $('#lpb-primary-color').value;
                const textColor = $('#lpb-text-color').value;
                const useGradient = $('#lpb-use-gradient').checked;

                const heroH = $('#lpb-hero-heading').value.trim();
                const heroS = $('#lpb-hero-sub').value.trim();
                const heroCTA = $('#lpb-hero-cta').value.trim();
                const heroAlt = $('#lpb-hero-alt').value.trim();
                const heroImg = state.heroImgData;
                const heroImgPos = state.heroImgPos;
                const heroLink = state.heroLink;

                // Build sections HTML
                const sectionsHTML = state.sections.map(s => {
                    let layoutClass = '';
                    let gridTemplate = '1fr';
                    
                    if (s.imgData) {
                        switch(s.imgPos) {
                            case 'right':
                                layoutClass = 'sec-img-right';
                                gridTemplate = '2fr 1.2fr';
                                break;
                            case 'left':
                                layoutClass = 'sec-img-left';
                                gridTemplate = '1.2fr 2fr';
                                break;
                            case 'above':
                                layoutClass = 'sec-img-above';
                                gridTemplate = '1fr';
                                break;
                            case 'below':
                                layoutClass = 'sec-img-below';
                                gridTemplate = '1fr';
                                break;
                        }
                    }
                    
                    // Button HTML if button text is provided
                    const buttonHTML = s.buttonText ? `<a class="sec-btn" href="${escapeHTML(s.buttonLink)}">${escapeHTML(s.buttonText)}</a>` : '';
                    
                    return `
                    <section class="sec ${layoutClass}">
                        ${s.title ? `<h2>${escapeHTML(s.title)}</h2>` : ''}
                        <div class="sec-wrap"${s.imgData ? ` style="grid-template-columns:${gridTemplate}"` : ''}>
                            ${s.imgData && (s.imgPos === 'left' || s.imgPos === 'above') ? `<figure><img src="${s.imgData}" alt="${escapeHTML(s.alt||'')}"></figure>` : ''}
                            <div class="sec-content">
                                ${s.text ? `<p>${escapeHTML(s.text).replace(/\n/g,'<br>')}</p>` : ''}
                                ${buttonHTML}
                            </div>
                            ${s.imgData && (s.imgPos === 'right' || s.imgPos === 'below') ? `<figure><img src="${s.imgData}" alt="${escapeHTML(s.alt||'')}"></figure>` : ''}
                        </div>
                    </section>
                `}).join('\n');

                const heroBgStyle = useGradient 
                    ? `background:linear-gradient(180deg,${adjustColor(primaryColor, 95)},#ffffff)` 
                    : `background:${adjustColor(primaryColor, 95)}`;

                // Google Fonts mapping
                const googleFontsMap = {
                    "'Poppins', sans-serif": "Poppins",
                    "'Montserrat', sans-serif": "Montserrat",
                    "'Playfair Display', serif": "Playfair+Display",
                    "'Roboto Condensed', sans-serif": "Roboto+Condensed",
                    "'Open Sans', sans-serif": "Open+Sans",
                    "'Lora', serif": "Lora",
                    "'Roboto Mono', monospace": "Roboto+Mono",
                    "'Nunito', sans-serif": "Nunito",
                    "'Merriweather', serif": "Merriweather",
                    "'Fira Sans', sans-serif": "Fira+Sans",
                    "'Source Sans Pro', sans-serif": "Source+Sans+Pro",
                    "'Oswald', sans-serif": "Oswald",
                    "'Raleway', sans-serif": "Raleway",
                    "'PT Sans', sans-serif": "PT+Sans",
                    "'Noto Sans', sans-serif": "Noto+Sans"
                };

                // Check if selected font is a Google Font
                let googleFontLink = '';
                if (googleFontsMap[font]) {
                    const fontName = googleFontsMap[font];
                    googleFontLink = `<link href="https://fonts.googleapis.com/css2?family=${fontName}:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">`;
                }

                return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${escapeHTML(siteTitle)}</title>
<meta name="description" content="${escapeHTML(heroS || siteTitle)}">
${googleFontLink}
<style>
:root{--base:${baseSize}px;--primary:${primaryColor};--text:${textColor}}
html{font-size:var(--base)}
body{margin:0;font-family:${font};line-height:1.6;color:var(--text);background:#ffffff}
.container{max-width:1100px;margin:0 auto;padding:24px}
header.hero{padding:64px 0 40px;${heroBgStyle}}
.hero h1{font-size:clamp(1.8rem,3vw + 1rem,3rem);margin:0 0 8px;${boldHeadings?'font-weight:800':'font-weight:600'}}
.hero p{font-size:1.05rem;margin:0 0 18px;${boldBody?'font-weight:600':''};color:${adjustColor(textColor, 30)}}
.hero .cta{display:inline-block;padding:12px 18px;background:var(--primary);color:#fff;border-radius:999px;text-decoration:none;border:1px solid ${adjustColor(primaryColor, -20)};transition:all 0.2s}
.hero .cta:hover{background:${adjustColor(primaryColor, -10)};transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.hero .media{margin-top:22px}
.hero img{max-width:100%;height:auto;border-radius:14px;border:1px solid ${adjustColor(textColor, 90)};box-shadow:0 8px 30px rgba(0,0,0,.06)}
.hero-grid{display:grid;gap:18px;align-items:center}
.hero-content{order:1}
.hero-media{order:2}
.hero-bg{background:linear-gradient(rgba(255,255,255,0.9),rgba(255,255,255,0.9)),url('${heroImg}');background-size:cover;background-position:center}
.sec{padding:32px 0;border-top:1px solid ${adjustColor(textColor, 95)}}
.sec h2{font-size:1.5rem;margin:0 0 10px;${boldHeadings?'font-weight:800':'font-weight:700'}}
.sec-wrap{display:grid;gap:18px;align-items:start}
.sec p{margin:0 0 16px;${boldBody?'font-weight:600':''}}
.sec-btn{display:inline-block;padding:10px 16px;background:var(--primary);color:#fff;border-radius:999px;text-decoration:none;border:1px solid ${adjustColor(primaryColor, -20)};margin-top:8px;transition:all 0.2s}
.sec-btn:hover{background:${adjustColor(primaryColor, -10)};transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.sec-img-above .sec-wrap,.sec-img-below .sec-wrap{grid-template-columns:1fr}
.sec-img-above figure{order:1}
.sec-img-above .sec-content{order:2}
.sec-img-below figure{order:2}
.sec-img-below .sec-content{order:1}
figure{margin:0}
figure img{max-width:100%;height:auto;border-radius:12px;border:1px solid ${adjustColor(textColor, 90)}}
footer{padding:40px 0;border-top:1px solid ${adjustColor(textColor, 95)};color:${adjustColor(textColor, 40)};font-size:.95rem;text-align:center}
@media (min-width:860px){
.hero-grid{grid-template-columns:${heroImgPos === 'background' ? '1fr' : heroImg && (heroImgPos === 'left' || heroImgPos === 'right') ? '1fr 1fr' : '1fr'}}
${heroImgPos === 'left' ? '.hero-content{order:2}.hero-media{order:1}' : ''}
${heroImgPos === 'background' ? '.hero-bg .hero-content{max-width:700px;margin:0 auto}' : ''}
.sec-wrap{grid-template-columns:${heroImg && heroImgPos === 'left' ? '1.2fr 2fr' : heroImg && heroImgPos === 'right' ? '2fr 1.2fr' : '1fr'}}
}
</style>
</head>
<body>
<header class="hero${heroImgPos === 'background' && heroImg ? ' hero-bg' : ''}">
<div class="container">
${heroImg && heroImgPos !== 'background' ? `<div class="hero-grid">` : ''}
${heroImg && heroImgPos === 'left' ? `<div class="hero-media"><img src="${heroImg}" alt="${escapeHTML(heroAlt||'Hero image')}"></div>` : ''}
<div class="hero-content">
${heroH ? `<h1>${escapeHTML(heroH)}</h1>` : ''}
${heroS ? `<p>${escapeHTML(heroS)}</p>` : ''}
${heroCTA ? `<a class="cta" href="${escapeHTML(heroLink)}">${escapeHTML(heroCTA)}</a>` : ''}
</div>
${heroImg && heroImgPos === 'right' ? `<div class="hero-media"><img src="${heroImg}" alt="${escapeHTML(heroAlt||'Hero image')}"></div>` : ''}
${heroImg && heroImgPos !== 'background' ? `</div>` : ''}
${heroImg && heroImgPos === 'below' ? `<div class="media"><img src="${heroImg}" alt="${escapeHTML(heroAlt||'Hero image')}"></div>` : ''}
</div>
</header>
<main class="container">
${sectionsHTML || '<!-- Add sections to show content here -->'}
</main>
<footer class="container">&copy; ${new Date().getFullYear()} ${escapeHTML(siteTitle)}. All rights reserved.</footer>
</body>
</html>`;
            }

            $('#lpb-generate').addEventListener('click', () => {
                const html = generateHTML();
                
                // Show modal with code
                $('#lpb-output').value = html;
                $('#lpb-modal').classList.add('show');
                $('#lpb-modal').setAttribute('aria-hidden','false');
                
                // Update preview
                updatePreview();
            });

            // Modal controls
            $('#lpb-close').addEventListener('click', () => {
                $('#lpb-modal').classList.remove('show');
                $('#lpb-modal').setAttribute('aria-hidden','true');
            });
            $('.lpb-backdrop').addEventListener('click', () => $('#lpb-close').click());

            // Copy to clipboard
            $('#lpb-copy').addEventListener('click', async () => {
                const ta = $('#lpb-output');
                ta.select(); ta.setSelectionRange(0, ta.value.length);
                try {
                    await navigator.clipboard.writeText(ta.value);
                    const old = $('#lpb-copy').textContent;
                    $('#lpb-copy').textContent = 'Copied!';
                    setTimeout(() => $('#lpb-copy').textContent = old, 900);
                } catch {
                    document.execCommand('copy');
                }
            });

            // Minify code
            $('#lpb-minify').addEventListener('click', () => {
                const ta = $('#lpb-output');
                let code = ta.value;
                
                // Basic minification (remove comments, extra whitespace)
                code = code
                    .replace(/<!--[\s\S]*?-->/g, '') // Remove HTML comments
                    .replace(/\s*[\r\n]+\s*/g, '')   // Remove line breaks
                    .replace(/>\s+</g, '><')         // Remove spaces between tags
                    .replace(/\s{2,}/g, ' ')         // Collapse multiple spaces
                    .trim();
                
                ta.value = code;
                $('#lpb-minify').textContent = 'Minified!';
                setTimeout(() => $('#lpb-minify').textContent = 'Minify', 1500);
            });

            // Helper function to adjust color lightness
            function adjustColor(hex, percent) {
                const num = parseInt(hex.slice(1), 16);
                const R = (num >> 16) + percent;
                const G = ((num >> 8) & 0x00FF) + percent;
                const B = (num & 0x0000FF) + percent;
                
                const constrained = (n) => Math.max(0, Math.min(255, n));
                
                return `#${((1 << 24) + (constrained(R) << 16) + (constrained(G) << 8) + constrained(B)).toString(16).slice(1)}`;
            }

        })();
    </script>
</body>
</html>
